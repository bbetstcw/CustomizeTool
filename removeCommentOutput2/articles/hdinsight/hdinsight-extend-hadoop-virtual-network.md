<properties
    pageTitle="Extend HDInsight with Virtual Network | Azure"
    description="Learn how to use Azure Virtual Network to connect HDInsight to other cloud resources, or resources in your datacenter"
    services="hdinsight"
    documentationcenter=""
    author="Blackmist"
    manager="jhubbard"
    editor="cgronlun" />
<tags
    ms.assetid="37b9b600-d7f8-4cb1-a04a-0b3a827c6dcc"
    ms.service="hdinsight"
    ms.devlang="na"
    ms.topic="article"
    ms.tgt_pltfrm="na"
    ms.workload="big-data"
    ms.date="10/21/2016"
    wacn.date=""
    ms.author="larryfr" />

# Extend HDInsight capabilities by using Azure Virtual Network
Azure Virtual Network allows you to extend your Hadoop solutions to incorporate on-premises resources such as SQL Server, or to create secure private networks between resources in the cloud.

[AZURE.INCLUDE [upgrade-powershell](../../includes/hdinsight-use-latest-powershell-and-cli.md)]

## <a id="whatis"></a>What is Azure Virtual Network?
[Azure Virtual Network](/documentation/services/networking/) allows you to create a secure, persistent network containing the resources you need for your solution. A virtual network allows you to:

* Connect cloud resources together in a private network (cloud-only).
  
    ![diagram of cloud-only configuration](./media/hdinsight-extend-hadoop-virtual-network/cloud-only.png)
  
    Using Virtual Network to link Azure services with Azure HDInsight enables the following scenarios:
  
  * **Invoking HDInsight services or jobs** from Azure websites or services running in Azure virtual machines.
  * **Directly transferring data** between HDInsight and Azure SQL Database, SQL Server, or another data storage solution running on a virtual machine.
	* **Combining multiple HDInsight servers** into a single solution. An example is using an HDInsight Storm server to consume incoming data, and then storing the processed data to an HDInsight HBase server. The raw data might also be stored to an HDInsight Hadoop server for future analysis by using MapReduce.
* Connect your cloud resources to your local datacenter network (site-to-site or point-to-site) by using a virtual private network (VPN).
  
    Site-to-site configuration allows you to connect multiple resources from your datacenter to the Azure virtual network by using a hardware VPN or the Routing and Remote Access service.
  
    ![diagram of site-to-site configuration](./media/hdinsight-extend-hadoop-virtual-network/site-to-site.png)
  
    Point-to-site configuration allows you to connect a specific resource to the Azure virtual network by using software VPN.
  
    ![diagram of point-to-site configuration](./media/hdinsight-extend-hadoop-virtual-network/point-to-site.png)
  
    Using Virtual Network to link the cloud and your datacenter enables similar scenarios to the cloud-only configuration. But instead of being limited to working with resources in the cloud, you can also work with resources in your datacenter.
  
  * **Directly transferring data** between HDInsight and your datacenter. An example is using Sqoop to transfer data to or from SQL Server or reading data generated by a line-of-business (LOB) application.
  * **Invoking HDInsight services or jobs** from an LOB application. An example is using HBase Java APIs to store and retrieve data from an HDInsight HBase cluster.

For more information on Virtual Network features, benefits, and capabilities, see the [Azure Virtual Network overview](/documentation/articles/virtual-networks-overview/).

> [AZURE.NOTE]
> You must create the Azure Virtual Network before provisioning an HDInsight cluster. For more information, see [Virtual Network configuration tasks](/documentation/services/networking/).
> 
> 

## Virtual Network requirements
> [AZURE.IMPORTANT]
> Creating an HDInsight cluster on a Virtual Network requires specific Virtual Network configurations, which are described in this section.
> 
> 

### Location-based Virtual networks
Azure HDInsight supports only location-based virtual networks, and does not currently work with virtual networks based on affinity group.

###Classic Virtual Network
Windows-based clusters require a v1 (Classic) Virtual Network. If you do not have the correct type of network, it will not be usable when you create the cluster.

If you have resources on a Virtual Network that is not usable by the cluster you plan on creating, you can create a new Virtual Network that is usable by the cluster, and connect it to the incompatible Virtual Network. You can then create the cluster in the network version that it requires, and it will be able to access resources in the other network since the two are joined. For more information on connecting classic and new Virtual Networks, see [Connecting classic VNets to new VNets](/documentation/articles/vpn-gateway-connect-different-deployment-models-portal/).

### Custom DNS
When creating a virtual network, Azure provides default name resolution for Azure services such as HDInsight that are installed in the network. However you may need to use your own Domain Name System (DNS) for situations such as cross network domain name resolution. For example, when communicating between services located in two joined virtual networks. HDInsight supports both the default Azure name resolution as well as custom DNS when used with Azure Virtual Network.

For more information on using your own DNS server with Azure Virtual Network, see the **Name resolution using your own DNS server** section of the [Name Resolution for VMs and Role Instances](/documentation/articles/virtual-networks-name-resolution-for-vms-and-role-instances/#name-resolution-using-your-own-dns-server) document.

### Secured Virtual Networks
The HDInsight service is a managed service, and requires Internet access during provisioning and while running. This is so that Azure can monitor the health of the cluster, initiate failover of cluster resources, change the number of nodes in the cluster through scaling operations, and other management tasks.

If you need to install HDInsight into a secured Virtual Network, you must allow inbound access over port 443 for the following IP addresses, which allow Azure to manage the HDInsight cluster.

* 168.61.49.99
* 23.99.5.239
* 168.61.48.131
* 138.91.141.162

Allowing inbound access from port 443 for these addresses will allow you to successfully install HDInsight into a secured virtual network.

> [AZURE.IMPORTANT]
> HDInsight doesn't support restricting outbound traffic, only inbound traffic. When defining Network Security Group rules for the subnet that contains HDInsight, only use inbound rules.
> 
> 

The following examples demonstrate how to create a new Network Security Group that allows the required addresses, and applies the security group to a subnet within your Virtual Network. These steps assume that you have already created a Virtual Network and subnet that you want to install HDInsight into.

> [AZURE.IMPORTANT]
> Note the `priority` value used in these examples; rules are tested against network traffic in order by priority. Once a rule matches the test criteria and is applied, no more rules are tested.
><p> 
> If you have custom rules that broadly block inbound traffic (such as a **deny all** rule), you may need to adjust the priority values in these examples or your custom rules so that the rules in the examples occur before the rules that block access. Otherwise, the **deny all** rule will be tested first and the rules in this example will never apply. You must also take care not block the default rules for an Azure Virtual Network. For example, you should not create a **deny all** rule that is applied before the default **ALLOW VNET INBOUND** rule (which has a priority of 65000.)
><p> 
> For more information on how rules are applied and the default inbound and outbound rules, see [What is a Network Security Group?](/documentation/articles/virtual-networks-nsg/).
> 
> 

**Using Azure PowerShell**

    $vnetName = "Replace with your virtual network name"
    $subnetName = "Replace with the name of the subnet that HDInsight will be installed into"
    # Get the Virtual Network object
    $vnet = Get-AzureVNetSite `
        -VNetName $vnetName 
    # Get the region the Virtual network is in.
    $location = $vnet.Location
    # Create a new Network Security Group.
    # And add exemptions for the HDInsight health and management services.
    $nsg = New-AzureNetworkSecurityGroup `
        -Name "hdisecure" `
        -Location $location `
        | Set-AzureNetworkSecurityRule `
            -name "hdirule1" `
            -Protocol "*" `
            -SourcePortRange "*" `
            -DestinationPortRange "443" `
            -SourceAddressPrefix "168.61.49.99" `
            -DestinationAddressPrefix "*" `
            -Action Allow `
            -Priority 300 `
            -Type Inbound `
        | Set-AzureNetworkSecurityRule `
            -Name "hdirule2" `
            -Protocol "*" `
            -SourcePortRange "*" `
            -DestinationPortRange "443" `
            -SourceAddressPrefix "23.99.5.239" `
            -DestinationAddressPrefix "*" `
            -Action Allow `
            -Priority 301 `
            -Type Inbound `
        | Set-AzureNetworkSecurityRule `
            -Name "hdirule3" `
            -Protocol "*" `
            -SourcePortRange "*" `
            -DestinationPortRange "443" `
            -SourceAddressPrefix "168.61.48.131" `
            -DestinationAddressPrefix "*" `
            -Action Allow `
            -Priority 302 `
            -Type Inbound `
        | Set-AzureNetworkSecurityRule `
            -Name "hdirule4" `
            -Protocol "*" `
            -SourcePortRange "*" `
            -DestinationPortRange "443" `
            -SourceAddressPrefix "138.91.141.162" `
            -DestinationAddressPrefix "*" `
            -Action Allow `
            -Priority 303 `
            -Type Inbound
    # Apply the NSG to the subnet
    Set-AzureNetworkSecurityGroupAssociation `
        -VirtualNetworkName $vnetName `
        -SubnetName $subnetName `
        -Name $nsg.Name

**Using the Azure CLI**

1. Use the following command to create a new network security group named `hdisecure`. Replace **LOCATION** with the Azure Virtual Network' location (region).

        azure network nsg create hdisecure LOCATION

2. Use the following to add rules to the new network security group that allow inbound communication on port 443 from the Azure HDInsight health and management service.

        azure network nsg rule create hdisecure hdirule1 -p "*" -o "*" -u "443" -f "168.61.49.99" -e "*" -c "Allow" -y 300 -r "Inbound"
        azure network nsg rule create hdisecure hdirule2 -p "*" -o "*" -u "443" -f "23.99.5.239" -e "*" -c "Allow" -y 301 -r "Inbound"
        azure network nsg rule create hdisecure hdirule3 -p "*" -o "*" -u "443" -f "168.61.48.131" -e "*" -c "Allow" -y 302 -r "Inbound"
        azure network nsg rule create hdisecure hdirule4 -p "*" -o "*" -u "443" -f "138.91.141.162" -e "*" -c "Allow" -y 303 -r "Inbound"

3. Once the rules have been created, use the following to apply the new network security group to a subnet. Replace **VNETNAME** and **SUBNETNAME** with the name of the Azure Virtual Network and the subnet that you will use when installing HDInsight.

        azure network nsg subnet add hdisecure VNETNAME SUBNETNAME

    Once this command completes, you can successfully install HDInsight into the secured Virtual Network on the subnet used in these steps.

> [AZURE.IMPORTANT]
> Using the above steps only open access to the HDInsight health and management service on the Azure cloud. This allows you to successfully install an HDInsight cluster into the subnet, however access to the HDInsight cluster from outside the Virtual Network is blocked by default. You will have to add additional Network Security Group rules if you wish to enable access from outside the Virtual Network.
><p> 
> For example, to allow RDP access from the internet, you will need to add a rule similar to the following: 
><p> 
><p> * Azure PowerShell - `Set-AzureNetworkSecurityRule -Name "RDP" -Protocol "*" -SourcePortRange "*" -DestinationPortRange "3389" -SourceAddressPrefix "*" -DestinationAddressPrefix "*" -Action Allow -Priority 304 -Type Inbound`
><p> * Azure CLI - `azure network nsg rule create hdisecure RDP -p "*" -o "*" -u "3389" -f "*" -e "*" -c "Allow" -y 304 -r "Inbound"`
> 
> 

For more information on Network Security Groups, see [Network Security Groups overview](/documentation/articles/virtual-networks-nsg/). For information on controlling routing in an Azure Virtual Network, see [User Defined Routes and IP forwarding](/documentation/articles/virtual-networks-udr-overview/).

## <a id="tasks"></a>Tasks and information
This section contains information on common tasks and information you may need when using HDInsight with a virtual network.

### Verify network connectivity
Some services, such as SQL Server, can limit incoming network connections. This will prevent HDInsight from successfully working with these services.

If you encounter problems accessing a service from HDInsight, consult the documentation for the service to ensure that you have enabled network access. You can also verify network access by creating an Azure virtual machine on the same virtual network, and use client utilities to verify that the virtual machine can connect to the service over the virtual network.

## <a id="nextsteps"></a>Next steps
The following examples demonstrate how to use HDInsight with Azure Virtual Network:

* [Analyze sensor data with Storm and HBase in HDInsight](/documentation/articles/hdinsight-storm-sensor-data-analysis/) - Demonstrates how to configure a Storm and HBase cluster in a virtual network, as well as how to remotely write data to HBase from Storm.
* [Provision Hadoop clusters in HDInsight](/documentation/articles/hdinsight-provision-clusters-v1/) - Provides information on provisioning Hadoop clusters, including information on using Azure Virtual Network.
* [Use Sqoop with Hadoop in HDInsight](/documentation/articles/hdinsight-use-sqoop/) - Provides information on using Sqoop to transfer data with SQL Server over a virtual network.

To learn more about Azure virtual networks, see the [Azure Virtual Network overview](/documentation/articles/virtual-networks-overview/).

